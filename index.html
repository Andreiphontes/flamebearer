<!DOCTYPE html>
<html>
<head>
<title>flamebearer</title>
<meta charset="utf-8">
<style>

html, body { height: 100%; }
body { font-family: sans-serif; margin: 0; line-height: 1.4; }
body.hover { background: #cfc; }
#intro { margin: 1em 2em; }
#intro h1, #intro p { margin: 15px 0; }
#fire-icon { fill: red; }
p.code { color: #444; line-height: 1.2; }
code span { color: #aaa; }
#canvas { width: 100%; }

</style>
</head>
<body>

<div id="intro">
    <h1>
        <svg id="fire-icon" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 15 15" style="enable-background:new 0 0 15 15;" xml:space="preserve"><path d="M7.5,0.5L5,4.5l-1.5-2 C2.9452,3.4753,0.8036,5.7924,0.8036,8.3036C0.8036,12.002,3.8017,15,7.5,15s6.6964-2.998,6.6964-6.6964 c0-2.5112-2.1416-4.8283-2.6964-5.8036l-1.5,2L7.5,0.5z M7.5,7c0,0,2.5,2.5618,2.5,4.5c0,0.8371-0.8259,2-2.5,2S5,12.3371,5,11.5 C5,9.6283,7.5,7,7.5,7z"/></svg>
        flamebearer
    </h1>
    <div id="log">
        <p>Generate a flame graph by <strong>dragging</strong> a JSON V8 log on this page:</p>

        <p class="code"><code>
            node --prof app.js <span># profile your app</span><br>
            node --prof-process --preprocess -j isolate*.log > v8.json <span># generate a V8 log</span><br>
            <span># then drag and drop the resulting file here</span>
        </code></p>
    </div>
</div>
<canvas id="canvas"></canvas>

<script src="index.js"></script>
<script>

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const body = document.body;

const logEl = document.getElementById('log');

let start = 0;
const now = () => {
    const end = performance.now();
    const len = end - start;
    start = end;
    return Math.round(len);
};

body.ondragover = () => {
    body.classList.add('hover');
    return false;
};
body.ondragleave = (e) => {
    body.classList.remove('hover');
};
body.ondrop = (e) => {
    body.classList.remove('hover');
    body.classList.add('loaded');

    now();
    logEl.innerHTML = 'Loading...';

    var reader = new FileReader();
    reader.onload = function (event) {
        logEl.innerHTML = `Loaded ${humanFileSize(event.target.result.length)} in ${now()} ms. `;

        requestAnimationFrame(() => {
            var json = JSON.parse(event.target.result);
            logEl.innerHTML += `Parsed in ${now()} ms. `;

            requestAnimationFrame(() => {
                const {names, stacks} = v8logToStacks(json);
                const levels = mergeStacks(stacks);
                logEl.innerHTML += `Processed in ${now()} ms. `;

                requestAnimationFrame(() => render(names, levels, stacks.length));
            });
        });
    };
    reader.readAsText(e.dataTransfer.files[0]);

    e.preventDefault();
    return false;
};

function render(names, levels, numTicks) {
    const pxPerLevel = 16;
    const w = canvas.width = canvas.clientWidth;
    const h = canvas.height = pxPerLevel * levels.length;
    const pxPerTick = w / numTicks;

    canvas.style.width = canvas.width + 'px';
    canvas.style.height = canvas.height + 'px';

    if (devicePixelRatio > 1) {
        canvas.width *= 2;
        canvas.height *= 2;
        ctx.scale(2, 2);
    }

    let numRects = 0;

    ctx.lineWidth = 1;
    ctx.strokeStyle = '#000';
    ctx.fillStyle = '#f77';

    for (let i = 0; i < levels.length; i++) {
        const level = levels[i];

        for (let j = 0; j < level.length; j += 3) {
            const x = level[j] * pxPerTick;
            const y = i * pxPerLevel;
            const sw = level[j + 1] * pxPerTick;
            // if (sw < 0.1) continue;
            ctx.beginPath();
            ctx.rect(x | 0, y | 0, sw | 0, pxPerLevel | 0);
            ctx.stroke();
            ctx.fill();
            numRects++;
        }
    }

    logEl.innerHTML += `Rendered ${numRects} blocks in ${now()} ms.`;
}

function humanFileSize(size) {
    var i = Math.floor(Math.log(size) / Math.log(1024));
    return Math.round(100 * (size / Math.pow(1024, i))) / 100 + ' ' + ['B', 'kB', 'MB', 'GB'][i];
}

</script>
</body>
</html>
